<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Zandronum (Web)</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #000;
      }
      #canvas {
        display: block;
        width: 100vw;
        height: 100vh;
        image-rendering: pixelated;
      }
      #hud {
        position: fixed;
        left: 10px;
        bottom: 10px;
        max-width: min(720px, calc(100vw - 20px));
        color: #e6edf3;
        font: 12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        background: rgba(0,0,0,0.55);
        border: 1px solid rgba(255,255,255,0.15);
        border-radius: 8px;
        padding: 8px 10px;
        pointer-events: none;
        white-space: pre-wrap;
      }
    </style>
  </head>

  <body>
    <canvas id="canvas" oncontextmenu="event.preventDefault()"></canvas>
    <div id="hud">Loading…</div>

    <!-- LiveKit JS SDK (UMD build) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/livekit-client/2.15.7/livekit-client.umd.js"></script>
    <!-- Emscripten output (generated by the Docker build) -->
    <script src="zandronum.js"></script>

    <script>
      const hud = document.getElementById('hud');
      const canvas = document.getElementById('canvas');

      function setHud(text) {
        hud.textContent = String(text ?? '');
      }

      function getParam(name) {
        try {
          const u = new URL(window.location.href);
          return u.searchParams.get(name);
        } catch {
          return null;
        }
      }

      function getGameIdFromUrl() {
        // Requested: ?q=<game_id>. Keep ?g=<uuid> as a compatibility alias.
        return getParam('q') || getParam('g');
      }

      function getNameFromUrl() {
        return getParam('name');
      }

      async function join(serverArg) {
        // serverArg may be either:
        //  - full join URL: https://api.synapse.beebs.dev/room/<uuid>/join
        //  - room UUID: <uuid>
        let arg = '';
        if (serverArg !== undefined && serverArg !== null) {
          arg = String(serverArg);
        }
        if (!arg) {
          const fromUrl = getGameIdFromUrl();
          if (fromUrl) arg = fromUrl;
        }
        if (!arg) {
          throw new Error('missing game id (use ?q=<uuid>)');
        }

        const joinUrl = (arg.startsWith('http://') || arg.startsWith('https://'))
          ? arg
          : `https://api.synapse.beebs.dev/room/${arg}/join`;

        // If ?name=<name> is present, forward it to the join API.
        let finalJoinUrl = joinUrl;
        try {
          const name = getNameFromUrl();
          if (name) {
            const u = new URL(joinUrl);
            u.searchParams.set('name', name);
            finalJoinUrl = u.toString();
          }
        } catch (_) {
          // Ignore URL parsing issues.
        }

        const resp = await fetch(finalJoinUrl, { method: 'GET' });
        if (!resp.ok) {
          throw new Error(`join failed: ${resp.status} ${resp.statusText}`);
        }
        const json = await resp.json();
        if (!json || typeof json.token !== 'string' || typeof json.url !== 'string') {
          throw new Error('join response missing token/url');
        }
        return { token: json.token, url: json.url };
      }

      function resizeCanvas(module) {
        // Match CSS pixels; SDL will handle scaling.
        const w = Math.max(1, window.innerWidth | 0);
        const h = Math.max(1, window.innerHeight | 0);
        if (module && typeof module.setCanvasSize === 'function') {
          module.setCanvasSize(w, h, false);
        } else {
          canvas.width = w;
          canvas.height = h;
        }
      }

      async function main() {
        if (!window.LivekitClient) {
          throw new Error('LiveKit SDK failed to load (LivekitClient global missing).');
        }
        if (typeof window.createZandronumModule !== 'function') {
          throw new Error('Emscripten module factory missing (createZandronumModule).');
        }

        setHud('Joining room…');
        const { token, url } = await join();

        setHud('Connecting WebRTC…');
        const room = new LivekitClient.Room({});

        // UDP queue for the WASM side to poll.
        const udpQueue = [];

        room.on(LivekitClient.RoomEvent.DataReceived, (payload, participant, kind, topic) => {
          if (topic !== 'udp') return;
          if ((participant?.identity ?? '') !== 'server') return;
          // payload is Uint8Array
          udpQueue.push(payload);
        });

        await room.connect(url, token);

        // JS transport surface consumed by src/network.cpp (EM_JS hooks).
        // Both directions use topic "udp".
        window.Module = window.Module || {};
        window.Module.__zanRtc = {
          recvUdp() {
            return udpQueue.length ? udpQueue.shift() : null;
          },
          sendUdp(u8, reliable) {
            if (!room || !room.localParticipant) return;
            const kind = reliable
              ? LivekitClient.DataPacket_Kind.RELIABLE
              : LivekitClient.DataPacket_Kind.LOSSY;
            room.localParticipant.publishData(u8, kind, { topic: 'udp' });
          },
        };

        setHud('Starting game…');

        const zand = await window.createZandronumModule({
          noInitialRun: true,
          canvas,
          print: (t) => { /* optional */ },
          printErr: (t) => { /* optional */ },
        });

        resizeCanvas(zand);
        window.addEventListener('resize', () => resizeCanvas(zand));

        // Kick off the engine in client mode. The IP is a dummy; UDP is bridged over WebRTC.
        zand.callMain(['-connect', '127.0.0.1']);

        setHud('');
      }

      main().catch((e) => {
        setHud(String(e?.stack || e));
        console.error(e);
      });
    </script>
  </body>
</html>
